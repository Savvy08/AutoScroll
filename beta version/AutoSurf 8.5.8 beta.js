// ==UserScript==
// @name         AutoSurf PRO 8.5.8 Beta
// @namespace    http://tampermonkey.net/
// @version      8.5.8-beta
// @description  –ê–≤—Ç–æ—Å—ë—Ä—Ñ–∏–Ω–≥ —Å UI, –∞–≤—Ç–æ-–∫–ª–∏–∫–æ–º, Tampermonkey-–º–µ–Ω—é: —Å—Ç–∞—Ä—Ç, —Å—Ç–æ–ø, —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç JSON
// @match        *://*/*
// @grant        GM_registerMenuCommand
// @grant        GM_setValue
// @grant        GM_getValue
// @run-at       document-end
// ==/UserScript==

(function () {
    'use strict';

    let siteList = JSON.parse(localStorage.getItem("autosurf_sites") || "null") || [
        "https://rutube.ru",
        "https://www.nytimes.com",
        "https://www.theguardian.com",
        "https://www.washingtonpost.com",
        "https://www.reuters.com",
        "https://www.bloomberg.com",
        "https://www.forbes.com",
        "https://www.rt.com",
        "https://lenta.ru",
        "https://ria.ru"
    ];

    let minTime = parseInt(localStorage.getItem("autosurf_minTime") || "60000");
    let maxTime = minTime + 30000;
    let clickCooldown = parseInt(localStorage.getItem("autosurf_clickCooldown") || (5 * 60 * 1000));
    let index = parseInt(localStorage.getItem("autosurf_index") || "0");

    const currentURL = window.location.href;
    const manualIndex = siteList.findIndex(site => currentURL.startsWith(site));
    if (manualIndex !== -1) index = manualIndex;
    localStorage.setItem("autosurf_index", index);

    let clickEnabled = localStorage.getItem("autosurf_clickEnabled") !== "false";
    let lastClickTime = parseInt(localStorage.getItem("autosurf_lastClick") || "0");
    let clickInProgress = false;
    let stopped = GM_getValue("autosurf_stopped", false);
    let collapsed = false;

    const panel = document.createElement("div");
    panel.id = "autosurf-panel";
    panel.innerHTML = `
        <style>
            #autosurf-panel {
                position:fixed; bottom:15px; left:15px;
                background:#1f1f1f; color:#fff; padding:10px;
                border-radius:8px; font-size:13px; z-index:999999;
                font-family:Arial,sans-serif; width:360px;
                box-shadow:0 4px 12px rgba(0,0,0,.4);
            }
            #autosurf-header { display:flex; justify-content:space-between; align-items:center; font-size:14px; margin-bottom:6px; }
            #autosurf-header small { color:#888; font-size:11px; }
            #collapse-btn {
                background:#444; color:#fff; border:none; padding:2px 6px;
                border-radius:4px; font-size:12px; cursor:pointer; margin-left:8px;
            }
            #autosurf-panel .buttons { display:flex; gap:4px; flex-wrap:wrap; margin-top:6px; }
            #autosurf-panel button {
                flex:1;
                background:#333; color:#fff; border:none; padding:6px;
                font-size:12px; border-radius:5px; cursor:pointer;
                transition:background 0.2s ease;
            }
            #autosurf-panel button:hover { background:#4caf50; }
            #autosurf-panel button.active { background:#d32f2f; }
            #progress { font-size:12px; margin-top:3px; color:#ccc; }
            #collapsed-timer {
                display:none;
                font-size:13px;
                margin-top:4px;
                color:#ccc;
            }
        </style>
        <div id="autosurf-header">
            <span>AutoSurf PRO 8.5.8 Beta</span>
            <div>
                <small>@Savvy08</small>
                <button id="collapse-btn">‚àí</button>
            </div>
        </div>
        <div id="collapsed-timer">‚è≥</div>
        <div id="content">
            <div id="timer">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div id="clickStatus">–ö–ª–∏–∫: ${clickEnabled ? "ON" : "OFF"} | –ß–µ—Ä–µ–∑: ...</div>
            <div id="progress">–°–∞–π—Ç ${index + 1} –∏–∑ ${siteList.length}</div>
            <div class="buttons">
                <button id="nextBtn">‚û° NEXT</button>
                <button id="restartClickBtn">‚ôª RESTART CLICK</button>
                <button id="toggleClickBtn" class="${clickEnabled ? "" : "active"}">üñ± ${clickEnabled ? "Click ON" : "Click OFF"}</button>
            </div>
            <div id="log" style="margin-top:4px;font-size:11px;color:#4caf50;"></div>
        </div>
    `;
    document.body.appendChild(panel);

    const content = panel.querySelector("#content");
    const timerDiv = panel.querySelector("#timer");
    const clickStatusDiv = panel.querySelector("#clickStatus");
    const progressDiv = panel.querySelector("#progress");
    const logDiv = panel.querySelector("#log");
    const collapseBtn = panel.querySelector("#collapse-btn");
    const collapsedTimer = panel.querySelector("#collapsed-timer");

    document.getElementById("nextBtn").onclick = () => goNext(true);
    document.getElementById("restartClickBtn").onclick = () => {
        lastClickTime = 0;
        localStorage.setItem("autosurf_lastClick", "0");
        clickInProgress = false;
        tryClick();
    };
    document.getElementById("toggleClickBtn").onclick = function () {
        clickEnabled = !clickEnabled;
        localStorage.setItem("autosurf_clickEnabled", clickEnabled);
        this.textContent = `üñ± ${clickEnabled ? "Click ON" : "Click OFF"}`;
        this.classList.toggle("active", !clickEnabled);
    };
    collapseBtn.onclick = () => {
        collapsed = !collapsed;
        content.style.display = collapsed ? "none" : "block";
        collapsedTimer.style.display = collapsed ? "block" : "none";
        collapseBtn.textContent = collapsed ? "+" : "‚àí";
    };

    function log(msg) {
        console.log("[AutoSurf]", msg);
        logDiv.textContent = msg;
    }

    function tryClick() {
        if (!clickEnabled || clickInProgress || Date.now() - lastClickTime < clickCooldown) return;
        const links = Array.from(document.querySelectorAll("a[href]")).filter(a =>
            a.offsetParent !== null && !a.href.startsWith("#") && !a.href.includes("javascript:")
        );
        if (links.length === 0) {
            log("‚ö† –ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Å—Å—ã–ª–æ–∫");
            return;
        }
        const link = links[Math.floor(Math.random() * links.length)];
        log(`üñ± –≠–º—É–ª—è—Ü–∏—è –∫–ª–∏–∫–∞: ${link.href}`);
        clickInProgress = true;
        lastClickTime = Date.now();
        localStorage.setItem("autosurf_lastClick", lastClickTime.toString());
        link.click();
        clickInProgress = false;
    }

    function goNext(manual = false) {
        if (stopped && !manual) return;
        let nextIndex = index + 1;
        if (nextIndex >= siteList.length) nextIndex = 0;
        localStorage.setItem("autosurf_index", nextIndex);
        location.href = siteList[nextIndex];
    }

    function scheduleNext() {
        const targetDelay = Date.now() + Math.floor(Math.random() * (maxTime - minTime)) + minTime;
        const interval = setInterval(() => {
            if (stopped) return clearInterval(interval);
            const remaining = Math.max(0, targetDelay - Date.now());
            const clickRemaining = Math.max(0, (clickCooldown - (Date.now() - lastClickTime)) / 1000);
            timerDiv.textContent = `‚è≥ –ü–µ—Ä–µ—Ö–æ–¥ —á–µ—Ä–µ–∑: ${Math.ceil(remaining / 1000)} —Å–µ–∫`;
            clickStatusDiv.textContent = `–ö–ª–∏–∫: ${clickEnabled ? "ON" : "OFF"} | –ß–µ—Ä–µ–∑: ${Math.ceil(clickRemaining)} —Å–µ–∫`;
            progressDiv.textContent = `–°–∞–π—Ç ${index + 1} –∏–∑ ${siteList.length}`;
            collapsedTimer.textContent = `‚è≥ ${Math.ceil(remaining / 1000)} —Å–µ–∫`;

            if (remaining <= 0) {
                clearInterval(interval);
                lastClickTime = 0;
                localStorage.setItem("autosurf_lastClick", "0");
                clickInProgress = false;
                tryClick();
                setTimeout(goNext, 1000);
            }
        }, 1000);
    }

    if (!stopped) scheduleNext();
    setInterval(() => { if (!stopped) scrollBy(0, 2); }, 30);

    // üß© Tampermonkey menu
    GM_registerMenuCommand("‚ñ∂ –°—Ç–∞—Ä—Ç", () => {
        GM_setValue("autosurf_stopped", false);
        stopped = false;
        scheduleNext();
    });
    GM_registerMenuCommand("‚õî –°—Ç–æ–ø", () => {
        GM_setValue("autosurf_stopped", true);
        stopped = true;
    });
    GM_registerMenuCommand("‚è≥ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ—Ö–æ–¥–∞", () => {
        const sec = parseInt(prompt("–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø–µ—Ä–µ—Ö–æ–¥–∞ (—Å–µ–∫):", "60")) || 60;
        localStorage.setItem("autosurf_minTime", sec * 1000);
        localStorage.setItem("autosurf_maxTime", (sec + 30) * 1000);
        alert("–û–±–Ω–æ–≤–ª–µ–Ω–æ. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
    });
    GM_registerMenuCommand("üì§ –≠–∫—Å–ø–æ—Ä—Ç —Å–∞–π—Ç–æ–≤ (–≤ —Ñ–∞–π–ª)", () => {
        const json = JSON.stringify(siteList, null, 2);
        const blob = new Blob([json], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "autosurf-sites-" + new Date().toISOString().slice(0, 19).replace(/:/g, "-") + ".json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });
    GM_registerMenuCommand("üì• –ò–º–ø–æ—Ä—Ç —Å–∞–π—Ç–æ–≤ (–∏–∑ —Ñ–∞–π–ª–∞)", () => {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json,application/json";
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const data = JSON.parse(evt.target.result);
                    if (Array.isArray(data)) {
                        localStorage.setItem("autosurf_sites", JSON.stringify(data));
                        alert("‚úÖ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
                    } else {
                        alert("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON.");
                    }
                } catch {
                    alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ JSON-—Ñ–∞–π–ª–∞.");
                }
            };
            reader.readAsText(file);
        };
        input.click();
    });

})();
